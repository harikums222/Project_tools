---
// AdvancedSIPCalculator Component
import AdSidebar from '../Ads/AdSidebar.astro';
---

<section class="py-12 bg-gradient-to-br from-emerald-50 via-white to-green-50">
	<div class="container mx-auto px-4">
		<div class="grid grid-cols-1 md:grid-cols-[240px_1fr] gap-12">
			<!-- Side Ads -->
			<div class="hidden md:block">
				<AdSidebar />
			</div>

			<!-- Core Content -->
			<div>
				<div class="text-center max-w-2xl mx-auto mb-12">
					<h1 class="text-4xl font-extrabold text-gray-900 mb-4 tracking-tight">Advanced SIP <span class="text-emerald-600">Calculator</span></h1>
					<p class="text-lg text-gray-600">Calculate future wealth with Step-up increments, Inflation adjustments, and Taxation.</p>
				</div>

				<div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden mb-16">
					<div class="grid grid-cols-1 lg:grid-cols-[1fr_400px]">
						<!-- Inputs -->
						<div class="p-8 space-y-8 border-b lg:border-b-0 lg:border-r border-gray-100">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
								<div>
									<label class="block text-sm font-bold text-gray-700 mb-2">Initial Monthly SIP (₹)</label>
									<input type="number" id="adv-sip-monthly" value="5000" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
								</div>
								<div>
									<label class="block text-sm font-bold text-gray-700 mb-2">Expected Return (%)</label>
									<input type="number" id="adv-sip-rate" value="12" step="0.1" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
								</div>
								<div>
									<label class="block text-sm font-bold text-gray-700 mb-2">Tenure (Years)</label>
									<input type="number" id="adv-sip-years" value="10" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
								</div>
								<div>
									<label class="block text-sm font-bold text-gray-700 mb-2">Yearly Step-up (%)</label>
									<input type="number" id="adv-sip-stepup" value="10" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
								</div>
							</div>

							<div class="pt-6 border-t border-gray-50 grid grid-cols-1 md:grid-cols-2 gap-6">
								<div>
									<label class="block text-sm font-bold text-gray-700 mb-2">Inflation Rate (%)</label>
									<div class="relative">
										<input type="number" id="adv-sip-inflation" value="6" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
										<span class="absolute right-4 top-3.5 text-gray-400 text-xs italic">Optional</span>
									</div>
								</div>
								<div>
									<label class="block text-sm font-bold text-gray-700 mb-2">LTCG Tax Rate (%)</label>
									<input type="number" id="adv-sip-tax" value="12.5" step="0.5" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
								</div>
							</div>
						</div>

						<!-- Results -->
						<div class="bg-gray-50 p-8 flex flex-col justify-center space-y-6">
							<div class="space-y-1">
								<p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Est. Maturity Value</p>
								<h2 class="text-4xl font-black text-gray-900" id="adv-sip-final">₹ 18,50,000</h2>
							</div>

							<div class="space-y-4 pt-6 border-t border-gray-200">
								<div class="flex justify-between items-center">
									<span class="text-sm text-gray-500">Total Invested</span>
									<span class="font-bold text-gray-900" id="adv-sip-invested">₹ 9,56,000</span>
								</div>
								<div class="flex justify-between items-center">
									<span class="text-sm text-gray-500">Est. Gains</span>
									<span class="font-bold text-emerald-600" id="adv-sip-gains">₹ 8,94,000</span>
								</div>
								<div class="flex justify-between items-center px-3 py-2 bg-white rounded-lg border border-gray-200">
									<span class="text-xs font-bold text-gray-400 uppercase">After 12.5% LTCG Tax</span>
									<span class="font-bold text-gray-900" id="adv-sip-posttax">₹ 17,50,000</span>
								</div>
								<div class="flex justify-between items-center px-3 py-3 bg-emerald-600 text-white rounded-xl shadow-lg ring-4 ring-emerald-50">
									<div class="flex flex-col">
										<span class="text-[10px] uppercase font-bold text-emerald-100 tracking-tighter">Inflation Adjusted</span>
										<span class="text-xs italic text-emerald-100">(Purchasing Power Value)</span>
									</div>
									<span class="text-xl font-black" id="adv-sip-inflation-adj">₹ 9,75,000</span>
								</div>
							</div>
                            <div class="pt-6 border-t border-gray-200">
                                <canvas id="advSipChart" height="150"></canvas>
                            </div>
						</div>
					</div>
				</div>

				<article class="prose prose-emerald max-w-none">
					<h2 class="text-3xl font-bold text-gray-900 mb-6">Advanced SIP Planning</h2>
					<p class="text-gray-600 leading-relaxed mb-6">
						Basic SIP calculators often ignore critical real-world factors like salary increments, inflation, and taxation. Our advanced tool accounts for these to give you a realistic picture of your future wealth.
					</p>

					<div class="grid grid-cols-1 md:grid-cols-3 gap-8 my-12">
						<div class="p-6 bg-white rounded-2xl border border-gray-100 shadow-sm transition-all hover:shadow-md">
							<div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center mb-4">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
								</svg>
							</div>
							<h3 class="font-bold text-gray-900 mb-2">Step-up SIP</h3>
							<p class="text-sm text-gray-600 leading-relaxed">Increasing your SIP amount as your income grows (e.g., 10% every year) can exponentially increase your final corpus.</p>
						</div>

						<div class="p-6 bg-white rounded-2xl border border-gray-100 shadow-sm transition-all hover:shadow-md">
							<div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center mb-4">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
								</svg>
							</div>
							<h3 class="font-bold text-gray-900 mb-2">Inflation Impact</h3>
							<p class="text-sm text-gray-600 leading-relaxed">Inflation reduces the purchasing power of money. ₹1 Crore after 20 years might only buy what ₹30 Lakh buys today.</p>
						</div>

						<div class="p-6 bg-white rounded-2xl border border-gray-100 shadow-sm transition-all hover:shadow-md">
							<div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center mb-4">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
								</svg>
							</div>
							<h3 class="font-bold text-gray-900 mb-2">LTCG Tax (12.5%)</h3>
							<p class="text-sm text-gray-600 leading-relaxed">Long Term Capital Gains Tax in India applies at 12.5% for equity returns exceeding ₹1.25 Lakh per financial year.</p>
						</div>
					</div>

					<h2 class="text-3xl font-bold text-gray-900 mb-6 font-display">How it's Calculated</h2>
					<p class="text-gray-600 leading-relaxed mb-6">
						The calculator iterates month-by-month over the selected tenure. Every 12 months, the monthly investment is increased by the specified step-up percentage. At the end of the duration, LTCG tax is calculated on the total gains (after skipping the standard ₹1.25L exemption). Finally, the inflation-adjusted value is derived using the formula:<br/>
						<code>Real Value = Nominal Value / (1 + i)^n</code>
					</p>
				</article>
			</div>
		</div>
	</div>
</section>

<script is:inline>
	const formatINR = (amount) => {
		return '₹ ' + Math.round(amount).toLocaleString('en-IN');
	};

	const calculateAdvancedSIP = () => {
		const startAmount = parseFloat(document.getElementById('adv-sip-monthly').value) || 0;
		const annualRate = parseFloat(document.getElementById('adv-sip-rate').value) || 0;
		const years = parseFloat(document.getElementById('adv-sip-years').value) || 0;
		const stepUpPercent = parseFloat(document.getElementById('adv-sip-stepup').value) || 0;
		const inflationPercent = parseFloat(document.getElementById('adv-sip-inflation').value) || 0;
		const taxRate = parseFloat(document.getElementById('adv-sip-tax').value) || 0;

		if (startAmount <= 0) return;

		let totalInvested = 0;
		let portfolioValue = 0;
		let currentMonthlySIP = startAmount;
		const monthlyRate = annualRate / 12 / 100;
		const totalMonths = years * 12;

        const labels = [];
        const investedData = [];
        const totalData = [];

		for (let m = 1; m <= totalMonths; m++) {
			totalInvested += currentMonthlySIP;
			// Simple monthly compounding: Value at start of month is (val + sip), then we add interest
			portfolioValue = (portfolioValue + currentMonthlySIP) * (1 + monthlyRate);

            if (m % 12 === 0) {
                const yr = m / 12;
                labels.push('Yr ' + yr);
                investedData.push(totalInvested);
                totalData.push(portfolioValue);
            }

			// Annual Step-up
			if (m % 12 === 0) {
				currentMonthlySIP *= (1 + stepUpPercent / 100);
			}
		}

		const gains = portfolioValue - totalInvested;
		
		// LTCG Tax Logic (India): 12.5% on gains above 1.25L
		const exemption = 125000;
		let tax = 0;
		if (gains > exemption) {
			tax = (gains - exemption) * (taxRate / 100);
		}
		const postTaxValue = portfolioValue - tax;

		// Inflation Adjustment
		// FV_real = FV / (1 + inf)^years
		const inflationAdjValue = postTaxValue / Math.pow(1 + inflationPercent / 100, years);

		document.getElementById('adv-sip-final').innerText = formatINR(portfolioValue);
		document.getElementById('adv-sip-invested').innerText = formatINR(totalInvested);
		document.getElementById('adv-sip-gains').innerText = formatINR(gains);
		document.getElementById('adv-sip-posttax').innerText = formatINR(postTaxValue);
		document.getElementById('adv-sip-inflation-adj').innerText = formatINR(inflationAdjValue);

        updateChart(labels, investedData, totalData);
	};

    let advSipChart;
    const updateChart = (labels, invested, total) => {
        const ctx = document.getElementById('advSipChart').getContext('2d');
        if (advSipChart) advSipChart.destroy();

        advSipChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Invested',
                        data: invested,
                        borderColor: '#94a3b8',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Total Value',
                        data: total,
                        borderColor: '#059669',
                        borderWidth: 3,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10, weight: 'bold' } } },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: { label: (ctx) => ctx.dataset.label + ': ' + formatINR(ctx.raw) }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (val) => {
                                if (val >= 10000000) return '₹' + (val/10000000).toFixed(1) + 'Cr';
                                if (val >= 100000) return '₹' + (val/100000).toFixed(1) + 'L';
                                return '₹' + val.toLocaleString('en-IN');
                            },
                            font: { size: 10 }
                        }
                    },
                    x: { ticks: { font: { size: 10 } } }
                }
            }
        });
    };

	[
		'adv-sip-monthly', 
		'adv-sip-rate', 
		'adv-sip-years', 
		'adv-sip-stepup', 
		'adv-sip-inflation', 
		'adv-sip-tax'
	].forEach(id => {
		const el = document.getElementById(id);
		if (el) el.addEventListener('input', calculateAdvancedSIP);
	});

	calculateAdvancedSIP();
</script>

<style>
	input::-webkit-outer-spin-button,
	input::-webkit-inner-spin-button {
	-webkit-appearance: none;
	margin: 0;
	}

	input[type=number] {
	-moz-appearance: textfield;
	}
</style>
